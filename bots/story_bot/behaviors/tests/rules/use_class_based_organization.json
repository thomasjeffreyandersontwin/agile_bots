{
    "priority":  1,
    "description":  "CRITICAL STRUCTURAL RULE: Test structure matches story graph hierarchy. File = sub-epic (test_<sub_epic>.py), Class = story (Test<ExactStoryName>), Method = scenario (test_<scenario_snake_case>). Getting this wrong creates files in wrong locations requiring deletion/recreation. BEFORE writing any test code, identify the parent sub-epic that contains the story.",
    "pre_flight_checklist":  {
        "description":  "Run this checklist BEFORE creating any test files",
        "steps":  [
            "Locate the story in story-graph.json",
            "Trace UP the hierarchy to find the parent sub-epic (may be nested several levels)",
            "Verify file name matches sub-epic in snake_case, NOT the story name",
            "Verify file location is test/domain/ (or test/CLI/ for CLI tests, test/panel/ for panel tests)",
            "Verify class name matches story name exactly in PascalCase",
            "Check if file already exists - if yes, add class to existing file, do not create new file"
        ]
    },
    "quick_reference":  {
        "description":  "Story graph level to test structure mapping",
        "table":  [
            {
                "story_graph_level":  "Sub-Epic (parent of story)",
                "maps_to":  "File name",
                "example":  "Sub-epic 'Edit Story Graph' -> test_edit_story_graph.py",
                "location":  "test/domain/ or test/CLI/ or test/panel/"
            },
            {
                "story_graph_level":  "Story",
                "maps_to":  "Class name",
                "example":  "Story 'Create Child Story Node' -> TestCreateChildStoryNode",
                "location":  "Inside the sub-epic test file"
            },
            {
                "story_graph_level":  "Scenario",
                "maps_to":  "Method name",
                "example":  "Scenario 'Create child node at hierarchy level' -> test_create_child_node_at_hierarchy_level",
                "location":  "Inside the story test class"
            }
        ]
    },
    "hierarchy_identification":  {
        "description":  "How to find the correct sub-epic for file naming",
        "steps":  [
            "Start at the story you're testing",
            "Go UP one level - this might be a story_group or sub-epic",
            "If it's a story_group, go up again",
            "Keep going up until you reach a sub-epic node (has 'sub_epics' or 'story_groups' property)",
            "That sub-epic name is your file name",
            "Example path: Epic 'Invoke Bot' -> Sub-Epic 'Invoke Bot Directly' -> Sub-Epic 'Manage Story Graph' -> Sub-Epic 'Edit Story Graph' -> Story 'Create Child Story Node'",
            "Result: File = test_edit_story_graph.py (NOT test_create_child_story_node.py)"
        ]
    },
    "common_mistakes":  {
        "description":  "Most common violations and how to avoid them",
        "mistakes":  [
            {
                "mistake":  "Naming file after the story instead of the sub-epic",
                "wrong":  "test_create_child_story_node.py",
                "right":  "test_edit_story_graph.py",
                "explanation":  "File name comes from parent SUB-EPIC, not the story itself"
            },
            {
                "mistake":  "Creating new directory for test area",
                "wrong":  "test/story_graph/test_*.py",
                "right":  "test/domain/test_*.py",
                "explanation":  "Use existing test directories (domain, CLI, panel)"
            },
            {
                "mistake":  "Creating separate helper file",
                "wrong":  "test/story_graph/story_graph_test_helper.py",
                "right":  "Extend test/domain/helpers/story_helper.py",
                "explanation":  "Add methods to existing helpers, don't create new standalone helpers"
            },
            {
                "mistake":  "Abbreviating class or method names",
                "wrong":  "class TestCreateChild",
                "right":  "class TestCreateChildStoryNode",
                "explanation":  "Use complete story/scenario name, no abbreviations"
            }
        ]
    },
    "do":  {
               "description":  "Map story hierarchy to test structure exactly. CRITICAL: File name comes from SUB-EPIC, not story.",
               "guidance":  [
                                {
                                    "description":  "BEFORE writing code: Identify parent sub-epic and state file path explicitly",
                                    "example":  [
                                                    "# Story Path: Invoke Bot -> Invoke Bot Directly -> Manage Story Graph -> Edit Story Graph -> Create Child Story Node",
                                                    "# Sub-Epic (for file): Edit Story Graph",
                                                    "# File: test/domain/test_edit_story_graph.py",
                                                    "# Class: TestCreateChildStoryNode",
                                                    "# Verify: File named after sub-epic 'Edit Story Graph', NOT story 'Create Child Story Node'"
                                                ]
                                },
                                {
                                    "description":  "Test file matches sub-epic name in snake_case",
                                    "example":  [
                                                    "# Sub-epic: 'Generate Bot Server And Tools'",
                                                    "# File: test_generate_bot_server_and_tools.py"
                                                ]
                                },
                                {
                                    "description":  "Test class matches story name EXACTLY in PascalCase",
                                    "example":  [
                                                    "# Story: 'Inject Guardrails as Part of Clarify Requirements'",
                                                    "class TestInjectGuardrailsAsPartOfClarifyRequirements:"
                                                ]
                                },
                                {
                                    "description":  "Test method matches scenario name EXACTLY in snake_case",
                                    "example":  [
                                                    "# Scenario: 'Generator creates bot tool for test_bot'",
                                                    "def test_generator_creates_bot_tool_for_test_bot(self):"
                                                ]
                                },
                                {
                                    "description":  "Test classes in same order as stories in story map",
                                    "example":  [
                                                    "class TestGenerateBotTools:  # First story",
                                                    "class TestGenerateBehaviorTools:  # Second story"
                                                ]
                                },
                                {
                                    "description":  "Check if file already exists - add to existing file, don't create duplicate",
                                    "example":  [
                                                    "# Sub-epic 'Edit Story Graph' already has test_edit_story_graph.py",
                                                    "# Add new class TestDeleteStoryNode to existing file",
                                                    "# Do NOT create test_delete_story_node.py"
                                                ]
                                }
                            ]
           },
    "dont":  {
                 "description":  "Don't use generic/abbreviated names or wrong hierarchy level for file naming. Don't create files in wrong locations.",
                 "guidance":  [
                                  {
                                      "description":  "Don't name file after story - use parent sub-epic",
                                      "example":  [
                                                      "# Story: 'Create Child Story Node'",
                                                      "# WRONG: test_create_child_story_node.py",
                                                      "# RIGHT: test_edit_story_graph.py (parent sub-epic is 'Edit Story Graph')"
                                                  ]
                                  },
                                  {
                                      "description":  "Don't create new test directories",
                                      "example":  [
                                                      "# WRONG: test/story_graph/",
                                                      "# RIGHT: test/domain/ (existing directory)"
                                                  ]
                                  },
                                  {
                                      "description":  "Don't create separate helper files",
                                      "example":  [
                                                      "# WRONG: test/story_graph/story_graph_test_helper.py",
                                                      "# RIGHT: Add methods to test/domain/helpers/story_helper.py"
                                                  ]
                                  },
                                  {
                                      "description":  "Don't abbreviate class names",
                                      "example":  [
                                                      "class TestGenBotTools:  # WRONG - use TestGenerateBotTools"
                                                  ]
                                  },
                                  {
                                      "description":  "Don't use generic class names",
                                      "example":  [
                                                      "class TestGuardrailsInjection:  # WRONG - story is 'Inject Guardrails as Part of Clarify Requirements'"
                                                  ]
                                  },
                                  {
                                      "description":  "Don't abbreviate method names",
                                      "example":  [
                                                      "def test_creates_tool(self):  # WRONG - scenario is 'Generator creates bot tool for test_bot'"
                                                  ]
                                  },
                                  {
                                      "description":  "Don't put test classes out of story map order",
                                      "example":  [
                                                      "class TestGenerateMCPBotServer:  # WRONG - should be after TestGenerateBotTools"
                                                  ]
                                  }
                              ]
             },
    "scanner":  "agile_bot.bots.base_bot.scanners.class_based_organization_scanner.ClassBasedOrganizationScanner"
}
